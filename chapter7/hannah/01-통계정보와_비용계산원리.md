### 통계정보와 비용 계산 원리

**선택도와 카디널리티**

- 선택도(Selectivity)란?
    - 전체 레코드 중에서 조건절에 의해 선택되는 레코드 비율
    - 가장 단순한 ‘=’ 조건으로 검색할 때의 선택도만 살펴보면, 컬럼 값 종류 개수(Number of Distinct Values, 이하 ‘NDV’)를 이용해 아래와 같이 구현한다
    - 선택도 = 1 / NDV
- 카디널리티(Cardinality)란?
    - 전체 레코드 중에서 조건절에 의해 선택되는 레코드 개수
    - 카디널리티 = 총 로우 수 * 선택도 = 총 로우 수 / NDV
- 옵티마이저는 카디널리티를 구하고, 그만큼의 데이터를 액세스하는 데 드는 비용을 계산해서 테이블 액세스 방식, 조인 순서, 조인 방식 등을 결정
- 선택도를 잘못 계산하면, 카디널리티와 비용도 잘못 계산하고, 결과적으로 비효율적인 액세스 방식과 조인 방식을 선택하게 된다
- 따라서 선택도를 계산할 때 NDV를 사용하므로 통계 정보 수집 과정에서 이 값을 정확히 구하는 것이 매우 중요
- = 통계정보 수집주기, 샘플링 비율 등을 잘 결정해야 하는 이유

**통계 정보**

구조

- 통계
    - 오브젝트 통계
        - 테이블 통계
        - 인텍스 통계
        - 컬럼 통계(히스토그램 포함)
    - 시스템 통계

1. 테이블 통계

   > **MySQL**서버는 5.7 버전까지 테이블과 인덱스에 대한 개괄적인 정보를 가지고 실행 계획을 수립하였습니다.
   >
   >
   > 하지만 이는 테이블 컬럼의 값들이 실제 어떻게 분포돼 있는지에 대한 정보가 없기 때문에 실행 계획의 정확도가 떨어지는 경우가 많았습니다.
   >
   > 그래서 MySQL 8.0 버전부터는 인덱스가 되지 않은 컬럼에 대해서도 데이터 분포도를 수집해서 저장하는 히스토그램(Histogram) 정보가 추가 되었습니다.
   >
   > **히스토그램**이 도입 되었다고 해서 기존의 테이블이나 인덱스의 통계 정보가 필요치 않은 것은 아닙니다.
   >
    - 테이블 통계 수집하는 명령어

        ```sql
        begin 
        	dbms_stats.gather_table_stats('scott', 'emp'); 
        end; 
        /
        ```

    - 테이블 통계 확인하는 명령어

        ```sql
        select * from all_tables where oner = ‘scott’ and table_name = ‘emp’
        ```

    - 주요 테이블 통계 항목 (위 코드 * 에 들어가는 항목들)
        - num_rows : 테이블에 저장된 총 레코드 개수
        - blocks  : 테이블 블록 수 = ‘사용된’ 익스텐트(데이터가 한 건이라도 입력된적이 있는 모든 익스텐트)에 속한 블록 수
        - avg_row_len : 레코드당 평균 길이(Bytes)
        - sample_size : 샘플링한 레코드 수
        - last_analyzed : 통계정보 수집일시
2. 인덱스 통계
    - 인덱스 통계를 수집하는 명령어
        - 인덱스 통계만 수집

            ```sql
            begin 
            	dbms_stats.gather_index_stats ( ownname => ‘scott’, indname => ‘emp_x01); 
            end; 
            /
            ```

        - 테이블 통계를 수집하면서 인덱스 통계도 같이 수집

            ```sql
            begin 
            	dbms_stats.gather_table_stats('scott', 'emp', cascade >= true); 
            end; 
            /
            ```

    - 인덱스 통계 정보 조회하는 명령어

        ```sql
        select * from all_indexes
        where owner = 'scott'
        and table_name = 'emp'
        and index_name = 'emp_x01';
        ```

    - 주요 인덱스 통계 항목 (위 코드 * 에 들어가는 항목들)
        - blevel : 브랜치 레벨의 약자. 인덱스 루트에서 리프 블록에 도달하기 직전까지 읽게 되는 블록 수
        - leaf_blocks : 인덱스 리프 블록 총 개수
        - num_rows  : 인덱스에 저장된 레코드 개수
        - distinct_key : 인덱스 키값의 조합으로 만들어지는 값의 종류 개수. 예 를 들어, C1+C2로 구성한 인덱스에서 더1 컬럼에 3개, 22 컬럼에 4개 값이 있으면 최대 12개 값의 종류가 만들어 질텐데, 인덱스에 저장된 데이터 기준으로 실제 입력된 값의 종류 개수를 구해 놓은 수치. 인덱스 키값을 모두 ‘-' 조건으로 조회할 때의 선택도(Selectivity)를 계산 하는 데 사용
        - avg_leaf_blocks_per_key : 인덱스 키값을 모두 '=' 조건으로 조회할 때 읽게 될 리프 블록 개수
        - avg_data_blocks_per_key : 인덱스 키값을 모두 '='조건으로 조회할 때 읽게 될 테이블 블록 개수
        - clustering_factor : 인덱스 키값 기준으로 테이블 데이터가 모여 있는 정도 인덱스 전체 레코드를 스캔하면서 테이블 레코드를 찾아 갈 때 읽게 될 테이블 블록 개수를 미리 계산해 놓은 수치
3. 컬럼 통계
    - 컬럼 통계는 테이블 통계 수집할 때 함께 수집됨
    - all_tab_col_statistics 뷰에서도 같은 정보를 확인할 수 있음
    - 주요 컬럼 통계 항목 (p. 505)

- 컬럼 히스토그램
    - 히스토그램은 컬럼 값별로 데이터 비중 또는 빈도를 미리 계산해 놓은 통계 정보이다
    - 실제 데이터를 읽어서 계산해 둔 값이므로 데이터 분포가 많이 변하지 않는 이상 거의 정확하다
    - 오라클 12c에서 사용하는 히스토그램 유형
        - 도수분포(FREQUENCY) : 값별로 빈도수 저장
        - 높이균형(HEIGHT-BALANCED) : 각 버킷의 높이가 동일하도록 데이터 분포 관리
        - 상위도수분포(TOP-FREQUENCY) : 많은 레코드를 가진 상위 n개 값에 대한 빈도수 저장
        - 하이브리드(HYBRID) : 도수분포와 높이균형 히스토그램의 특성 결합

1. 시스템 통계
    - 시스템 통계는 애플리케이션 및 하드웨어 성능 특성을 측정한 것
        - CPU 속도
        - 평균적인 Single Block I/O 속도
        - 평균적인 Multiblock I/O 속도
        - 평균적인 Multiblock I/O 개수
        - I/O 서브시스템의 최대 처리량(Throughput)
        - 병렬 Slave의 평균적인 처리량(Throughput)

**비용 계산 원리**

- 인덱스 키 값을 모두 ‘=’ 조견으로 검색할 때는 인덱스 통계만으로도 쉽게 비용을 계산할 수 있다

    ```sql
    비용 = BLEVEL                        -- 인덱스 수직적 탐색 비용
    	  + AVG_LEAF_BLOCKS_PER_KEY       -- 인덱스 수평적 탐색 비용
        + AVG_DATA_BLOCKS_PER_KEY       -- 테이블 랜덤 액세스 비용
    ```

- 인덱스 키 값이 모두 ‘=’ 조건이 아닐 때는 컬럼 통계까지 활용한다

    ```sql
    비용 = BLEVEL                                   -- 인덱스 수직적 탐색 비용
    	  + LEAF_BLOCKS        X 유효 인덱스 선택도      -- 인덱스 수평적 탐색 비용
        + CLUSTERING_FACTOR  X 유효 테이블 선택도      -- 테이블 랜덤 액세스 비용
    ```
